#!/bin/sh   # -*-pd-*-
# Quick Start for ZXID
######################
# Sampo Kellomäki (sampo@iki.fi)
# $Id: Quick,v 1.9 2010-01-08 02:10:09 sampo Exp $

time (LD_LIBRARY_PATH=/apps/lib make all ENA_GEN=1 ENA_PG=1)
set env LD_LIBRARY_PATH=/apps/lib

if false; then
  tar xvzf zxid-0.7.tgz
  cd zxid-0.8
  # N.B.  There is no configure script. The Makefile works for all
  #       supported platforms by provision of correct TARGET option.
  # N.B2: We distribute some generated files. If they are missing, you need
  #       to regenerate them: make cleaner; make dep ENA_GEN=1
  make                   # default Linux. Do `make TARGET=sol8' for Solaris
  make dir               # Creates /var/zxid hierarchy
  make samlmod           # optional
  make samlmod_install   # optional: install Net::SAML perl module
  make phpzxid           # optional
  make phpzxid_install   # optional: install php_zxid.so PHP extension
  cp zxid <webroot>/
fi

# configure your web server to recognize zxid a CGI, e.g.
mini_httpd -p 8443 -c 'zxid*' -S -E zxid.pem -l /tmp/mini.stderr &
mini_httpd -p 8444 -c 'zxid*' -S -E /var/zxid/pem/ssl-nopw-cert.pem -l /tmp/mini.stderr &

export LD_LIBRARY_PATH=/apps/lib
ulimit -c unlimited
mini_httpd -p 8081 -c 'zxid*' &
tailf /var/tmp/zxid.stderr &
tailf /var/zxid/log/xml.dbg | ~/zxid/xml-pretty.pl &
tailf /var/log/apache2/error.log | perl -pe 's/((zxidp)|(eid))/\e[1;31m$1\e[0m/g' &
tail -f tmp/err-httpd &

echo Edit your /etc/hosts to contain
echo 127.0.0.1       localhost sp1.zxidcommon.org sp1.zxidsp.org idp1.zxidp.org sp.tas3.pt idp.tas3.pt
echo
echo Point your browser to
echo  https://sp1.zxidsp.org:8443/zxidhlo?o=E
echo  https://sp1.zxidsp.org:8443/zxidhlo.pl?o=E      # Perl version
echo  https://sp1.zxidsp.org:8443/zxidhlo.php?o=E     # PHP version
echo  https://sp1.zxidsp.org:8443/zxidhrxmlwsc?o=E
echo  https://idp1.zxidp.org:8443/zxididp?o=F         # The IdP
echo
echo  http://sp.tas3.pt:8080/zxidservlet/appdemo
echo  http://sp.tas3.pt:8082/zxidhlo.pl?o=E
echo  http://sp.tas3.pt:8082/zxidhlo.php?o=E
echo  http://sp.tas3.pt:8082/protected/saml?o=E       # mod_auth_saml
echo  http://sp.tas3.pt:8082/protected/env.cgi
echo  http://idp.tas3.pt:8081/zxididp?o=F
echo
echo tail -f /var/tmp/zxid.stderr &
echo tail -f /var/zxid/log/act &
echo
echo wireshark -i lo -f 'port 8080 or port 8081'&
echo wireshark -i eth0 -f 'host 87.106.206.244' -k -S -l

(ip.addr eq 1.1.1.1)

Testing
-------

http://idp.tas3.pt:8081/zxidtest.pl
./zxtest.pl -a -a -dx

Testing mod_php and mod_perl
----------------------------

emacs /apps/apache/std/conf/httpd.conf
/apps/apache/std/bin/apachectl start
tailf tmp/err-httpd &

Testing Java
------------

make javazxid
export LD_LIBRARY_PATH=/home/sampo/zxid/zxidjava:/apps/lib:$LD_LIBRARY_PATH
export JAVA_HOME=/apps/java/j2sdk1.4.2
cd /home/sampo/apache-tomcat-5.5.20/
tail -f logs/catalina.out &
ulimit -c unlimited
killall java; bin/startup.sh
http://sp1.zxidsp.org:8080/zxidservlet/zxidHLO?o=E
http://sp.tas3.pt:8080/zxidservlet/appdemo

gdb /apps/java/j2sdk1.4.2/bin/java core
gdb /apps/java/j2sdk1.4.2/bin/java /d/sampo/apache-tomcat-5.5.20/core
tcpdump -lnA -s 1024 dst port 8080

./zxcall -d -a http://idp.tas3.pt:8081/zxididp?o=B tastest:tastest -t urn:x-foobar -e '<foobar>Do It!</foobar>'

GDB setup
---------

set env CONTENT_LENGTH=222
set env QUERY_STRING=o=S
set env LD_LIBRARY_PATH=/apps/lib
dir /aino/openssl-0.9.8q/ssl
dir /aino/openssl-0.9.8q/crypto/evp
dir /aino/openssl-0.9.8q/crypto/asn1
dir /aino/openssl-0.9.8q/crypto/pem
dir /aino/openssl-0.9.8q/crypto/x509
dir /aino/openssl-0.9.8q/crypto/object

dir /aino/openssl-1.0.0c/ssl
dir /aino/openssl-1.0.0c/crypto/evp
dir /aino/openssl-1.0.0c/crypto/asn1
dir /aino/openssl-1.0.0c/crypto/pem
dir /aino/openssl-1.0.0c/crypto/x509
dir /aino/openssl-1.0.0c/crypto/object

<<EOF: >>
